<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>电影用户管理</title>
	<link rel="icon" href="/Movie/static/assets/img/icon.ico" type="image/x-icon"/>
	
	<!-- 字体与图标文件 -->
	<script src="/Movie/static/assets/js/plugin/webfont/webfont.min.js"></script>
	<!-- 提示框的js -->
	<script src="/Movie/static/assets/js/plugin/sweetalert/sweetalert.min.js"></script>
	<script>
		WebFont.load({
			custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"], urls: ['/Movie/static/assets/css/fonts.min.css']},
			active: function() {
				sessionStorage.fonts = true;
			}
		});
	</script>

	<!-- CSS 文件 -->
	<link rel="stylesheet" href="/Movie/static/assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="/Movie/static/assets/css/atlantis.min.css">
</head>
<body>
	<div class="wrapper">
		<div class="head"></div>
		<!-- Sidebar -->
		<div class="navBatStyle"></div>
		<div class="main-panel">
			<div class="content">
				<div class="page-inner">
					<div class="page-header">
						<h4 class="page-title">用户详情管理</h4>
						<ul class="breadcrumbs">
							<li class="nav-home">
								<a href="#">
									<!-- 房子标签 -->
									<i class="flaticon-home"></i>
								</a>
							</li>
							<li class="separator">
								<i class="flaticon-right-arrow"></i>
							</li>
							<li class="nav-item">
								<a href="#">用户管理</a>
							</li>
							<li class="separator">
								<i class="flaticon-right-arrow"></i>
							</li>
							<li class="nav-item">
								<a href="#">用户详情管理</a>
							</li>
						</ul>
					</div>
					<!-- 表格开始标签 -->
					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<div class="d-flex align-items-center">
										<h4 class="card-title">添加数据</h4>
										<button class="btn btn-primary btn-round ml-auto" data-toggle="modal" onclick="openAdd()">
											<i class="fa fa-plus"></i>
											新增用户
										</button>
									</div>
								</div>
								<div class="card-body">
									<!-- 弹出层拟态框  start -->
									<div class="modal fade" id="addRowModal" tabindex="-1" role="dialog" aria-hidden="true">
										<div class="modal-dialog" role="document">
											<div class="modal-content">
												<div class="modal-header no-bd">
													<h5 class="modal-title">
														<span class="fw-mediumbold">
														新增操作</span> 
													</h5>
													<button type="button" class="close" data-dismiss="modal" aria-label="Close">
														<span aria-hidden="true">&times;</span>
													</button>
												</div>
												<div class="modal-body">
													<!-- <p class="small">使用此表单创建新行，确保将它们全部填充</p> -->
													<form>
														<div class="row">
															<div class="col-sm-12">
																<div class="form-group form-group-default">
																	<label>用户名</label>
																	<input id="userId" name="userId" type="hidden">
																	<input id="addName" name="addName" type="text" class="form-control" placeholder="请输入用户名">
																</div>
															</div>
															<div class="col-sm-12">
																<div class="form-group form-group-default">
																	<label>密码</label>
																	<input id="password" name="password" type="password" class="form-control" placeholder="请输入密码">
																</div>
															</div>
															<div class="col-sm-12">
																<div class="form-group form-group-default">
																	<label>邮箱</label>
																	<input id="email" name="email" type="text" class="form-control" placeholder="请输入邮箱">
																</div>
															</div>
															<div class="col-sm-12">
																<div class="form-group form-group-default">
																	<label>手机号</label>
																	<input id="phone" name="phone" type="text" class="form-control" placeholder="请输入手机号">
																</div>
															</div>
															<div class="col-sm-12">
																<div class="form-group form-group-default">
																	<label for="selectRole">分配角色</label>
																	<select class="form-control" id="selectRole">
																		<option value="0">请选择角色</option>
																		<option value="2">影院管理员</option>
																		<option value="3">普通用户</option>
																	</select>
																</div>
															</div>
															<div class="col-sm-12">
																<div class="form-group form-group-default">
																	<label for="uploadImg">头像上传</label>
																	<input type="file" class="form-control-file" id="uploadImg">
																</div>
															</div>
															<div class="imgShow" style="display: none">
															</div>
														</div>
													</form>
												</div>
												<div class="modal-footer no-bd">
													<button type="button" id="addRowButton"  class="btn btn-primary">保存</button>
													<button type="button" class="btn btn-danger" data-dismiss="modal">关闭</button>
												</div>
											</div>
										</div>
									</div>
									<!-- 弹出层拟态框  end -->
									<div class="table-responsive">
										<table id="add-row" class="display table table-striped table-hover" >
											<thead>
												<tr>
													<th>用户名</th>
													<th>邮箱</th>
													<th>登录时间</th>
													<th style="width: 10%">操作</th>
												</tr>
											</thead>
											<tbody>
												<tr>
													<td>小明</td>
													<td>123@qq.com</td>
													<td>普通用户</td>
													<td>
														<div class="form-button-action">
															<button type="button" data-toggle="tooltip" title="" class="btn btn-link btn-primary btn-lg" data-original-title="Edit Task">
																<i class="fa fa-edit"></i>
															</button>
															<button  type="button" data-toggle="tooltip" title="" class="btn btn-link btn-danger" data-original-title="Remove">
																<i class="fa fa-times"></i>
															</button>
														</div>
													</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- 表格结束标签 -->
				</div>
			</div>
			<footer class="footer">
				<div class="container-fluid">
					<div class="copyright ml-auto">
						该系统版权为作者用户，如其他人使用请联系作者
					</div>	
				</div>
			</footer>
		</div>
	</div>
	<!--   Core JS Files   -->
	<script src="/Movie/static/assets/js/core/jquery.3.2.1.min.js"></script>
	<script src="/Movie/static/assets/js/core/popper.min.js"></script>
	<script src="/Movie/static/assets/js/core/bootstrap.min.js"></script>
	<!-- jQuery UI -->
	<script src="/Movie/static/assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
	<script src="/Movie/static/assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>
	
	<!-- jQuery Scrollbar -->
	<script src="/Movie/static/assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
	<!-- Datatables -->
	<script src="/Movie/static/assets/js/plugin/datatables/datatables.min.js"></script>
	<!-- Atlantis JS -->
	<script src="/Movie/static/assets/js/atlantis.min.js"></script>
	<!-- Atlantis DEMO methods, don't include it in your project! -->
	<script src="/Movie/static/assets/js/setting-demo2.js"></script>
	<script >
		$(document).ready(function() {
			$(".navBatStyle").load("NavBar.html");
			$(".head").load("head.html");
			$('#add-row').DataTable({
				"pageLength": 10,
				"ajax": {
					"url": "http://localhost:8080/Movie/user/api/findUserPage",
					"dataSrc": "data.list",//这里是后台返回的数据对象
					"type":"POST",   //请求方式
					"data": function (d) {//d 是原始的发送给服务器的数据，默认很长。
						var param = {};//因为服务端排序，可以新建一个参数对象
						param.start = d.start;//开始的序号
						param.length = d.length;//要取的数据的条数
						return param;//自定义需要传递的参数。
					}
				 },
				 "columnDefs": [{"defaultContent": "","targets": "_all"}],
				 "columns":[
					 { "data": "userName" },
					 { "data": "email" },
					 { "data": "loginTime",
					  "render": function (data, type, full, callback) {
							  if(data==null){
								  return "该用户暂未登录"
							  }else{
								  return data
							  }
						}
					  },
					 {
					   "data": "id",//json
					   "render": function (data, type, full, callback) {
					 	  return ('<td> <div class="form-button-action"> <button type="button"  onclick="openAdd('+data+')" data-toggle="tooltip" title="" class="btn btn-link btn-primary btn-lg" data-original-title="Edit Task"> <i class="fa fa-edit"></i> </button> <button type="button" onclick="delUser('+data+')" data-toggle="tooltip" title="" class="btn btn-link btn-danger" data-original-title="Remove"> <i class="fa fa-times"></i> </button> </div> </td>');
						}
					 }
					 ],
				"language": {
					"sProcessing": "处理中...",
					"sLengthMenu": "显示 _MENU_ 项结果",
					"sZeroRecords": "没有匹配结果",
					"sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
					"sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
					"sInfoFiltered": "(由 _MAX_ 项结果过滤)",
					"sInfoPostFix": "",
					"sSearch": "搜索:",
					"sUrl": "",
					"sEmptyTable": "表中数据为空",
					"sLoadingRecords": "载入中...",
					"sInfoThousands": ",",
					"oPaginate": {
					"sFirst": "首页",
					"sPrevious": "上一页",
					"sNext": "下一页",
					"sLast": "末页"
					},
					"oAria": {
					"sSortAscending": ": 以升序排列此列",
					"sSortDescending": ": 以降序排列此列"
					}
				}
			});
			// 添加的方法
			$('#addRowButton').click(function() {
				var data = $("#userId").val()
				updateUser(data)
				$('#addRowModal').modal('hide');
			});
		});
		//修改或者添加方法
		function updateUser(Id){
			var data = new FormData();
			data.append("userName",$("#addName").val());
			if($("#password").val()!=""&&("#password").val()!=undefined){
				data.append("password",$("#password").val());
			}
			if($("#selectRole").val()!=null){
				data.append("roleId",$("#selectRole").val());
			}
			data.append("email",$("#email").val());
			data.append("phone",$("#phone").val());

			if($('#uploadImg').get(0).files[0]!=undefined){
				data.append("file",$('#uploadImg').get(0).files[0]);
			}
			if(Id==null||Id==""){
				$.ajax({
					    url:"http://localhost:8080/Movie/user/api/register",    //请求的url地址
						data:data,
						processData: false,
						contentType: false,
					    type:"POST",   //请求方式
					    success:function(data){
							swalAlert(data)
							clear();
							$("#add-row").DataTable().ajax.reload();
					    }
					});
			}else{
				data.append("id",Id);
				if($("#password").val()!=""||$("#password").val()!=null){
					data.append("old_password","bW92aWU=");
				}
				$.ajax({
					    url:"http://localhost:8080/Movie/user/api/updateUser",    //请求的url地址
						data:data,
						contentType: false,
						processData: false,
						type:"POST",   //请求方式
					    success:function(data){
							swalAlert(data)
							clear();
							$("#add-row").DataTable().ajax.reload();
					    }
				});
			}
		}
		//删除用户方法
		function delUser(id){
			$.ajax({
				    url:"http://localhost:8080/Movie/user/api/delUser",    //请求的url地址
					data:{
						"id":id
					},
				    dataType:"json",   //返回格式为json
				    type:"POST",   //请求方式
				    success:function(data){
						swalAlert(data)
						$("#add-row").DataTable().ajax.reload()
				    },
				});
		}
		function openAdd(id){
			$('#addRowModal').modal('show');
			if(id==null){
				clear();
			}else{
				$.ajax({
					    url:"http://localhost:8080/Movie/user/api/findOneUser",    //请求的url地址
						data:{
							"id":id
						},
					    dataType:"json",   //返回格式为json
					    type:"POST",   //请求方式
					    success:function(data){
					    	console.log(data)
							$("#addName").val(data.data.userName);
							$("#password").attr("placeholder","不填写密码则为原密码")
							$("#email").val(data.data.email);
							$("#phone").val(data.data.phone);
							$("#userId").val(data.data.id);
							$("#selectRole").val(data.data.roleId);
							$(".imgShow").attr("style","display:block");
							$(".imgShow").html('<div class="col-sm-12">'+
									'<div class="form-group form-group-default">'+
									'<figure class="imagecheck-figure">'+
									'<img src="/Movie/'+data.data.img+'" alt="title" class="imagecheck-image">'+
									'</figure>'+
									'</div>'+
									'</div>')
					    }
					});
			}
		}
		// 提示框公用方法
		function swalAlert(data){
			if(typeof data=="string"){
				data = JSON.parse(data);
			}
			if(data.status=='200'){
				swal("操作成功!", "系统提示操作成功!", {
					icon : "success",
					buttons: {
						confirm: {
							className : 'btn btn-success'
						}
					},
				});
			}else{
				swal("操作失败!", "系统提示请稍后重试!", {
					icon : "error",
					buttons: {
						confirm: {
							className : 'btn btn-danger'
						}
					},
				});
			}
		}
		function clear() {
			$("#addName").val("");   		//用户名清空
			$("#password").val("");			//密码清空
			$("#email").val("");			//右键清空
			$("#phone").val("");			//手机号清空
			$("#userId").val("");			//用户id清空
			$("#selectRole").val(0);		//角色下拉清空
			$("#uploadImg").val("");		//图片选择器清空
			$(".imgShow").attr("style","display:none");
			$("#imgShow").html("");
		}
	</script>
</body>
</html>